# 用户管理

Linux是基于用户身份对系统资源进行管理的操作系统

## 用户和组

用户账号:UID(User Identity,用户标识号)

| 用户类型 | CentOS-6 UID | CentOS-7 UID |
| -------- | ------------ | ------------ |
| 超级用户 | 0            | 0            |
| 系统用户 | 1-499        | 1-999        |
| 普通用户 | 500-65535    | 1000-65535   |

组账号:GID(Group Identify,组标识号)

初始组(私有组),创建用户时加入的组

附加组(公共组),有初始组的用户额外加入的组

## 用户和组相关文件

### 用户信息文件 /etc/passwd

| 列数 | 描述                                                         |
| ---- | ------------------------------------------------------------ |
| 1    | 用户名                                                       |
| 2    | 密码占位符                                                   |
| 3    | 用户ID(UID)                                                  |
| 4    | 组ID(GID)                                                    |
| 5    | 用户描述信息                                                 |
| 6    | 用户家目录(root: /root ; 普通用户: /home/username)           |
| 7    | 登录shell类型(/bin/bash 能登录系统; /sbin/nologin 不能登录系统) |

### 用户密码文件 /etc/shadow

| 列数 | 描述                                                         |
| ---- | ------------------------------------------------------------ |
| 1    | 用户名                                                       |
| 2    | 加密后的密码(系统用户的密码都是 !! 或 \* 表示无密码不能登录) |
| 3    | 密码最近更改时间(时间戳形式)                                 |
| 4    | 密码最短有效时间                                             |
| 5    | 密码最长有效期                                               |
| 6    | 密码到期前的警告天数                                         |
| 7    | 密码过期后宽限天数                                           |
| 8    | 密码失效时间(时间戳形式)                                     |
| 9    | 保留                                                         |

时间戳转日期:

```shell
date -d "1970-01-01 19527 days"
```

日期转时间戳:

```shell
echo $($(date -date="2020/02/01" +%s)/86400+1)
```

### 组信息文件 /etc/group

| 列数 | 描述         |
| ---- | ------------ |
| 1    | 组名         |
| 2    | 组密码占位符 |
| 3    | 组ID(GID)    |
| 4    | 组成员列表   |

### 组密码文件 /etc/gshadow

| 列数 | 描述                                   |
| ---- | -------------------------------------- |
| 1    | 用户组                                 |
| 2    | 组密码,可以为空或!,表示没有密码        |
| 3    | 组管理员,可以为空;多个管理员用逗号分隔 |
| 4    | 组成员,用逗号分隔                      |

### 用户家目录

root: /root

普通用户: /home/username

### 用户邮箱目录 /var/spool/mail

例如: zhangsan 的邮件所在位置: /var/spool/mail/zhangsan

### 用户模板目录 /ect/skel

新建用户时会将模板目录下的文件复制到新用户的家目录中(并同时修改权限)

## 用户和组相关命令

### 添加用户

~~~shell
useradd [选项] 用户名
	-u UID # 用指定UID创建用户
	-g 组名 # 指定初始组
	-d 目录 # 指定家目录
	-s shell类型 # 指定shell类型(/sbin/nologin 不允许登录)
	-r # 创建系统用户,一般和-s 同时使用
~~~

useradd 命令再创建用户时会参考两个配置文件:

*   /etc/default/useradd
*   /etc/login.defs

#### /etc/default/useradd

| 字段                 | 描述                                      |
| -------------------- | ----------------------------------------- |
| GROUP=100            | 创建新用户时默认初始组的GID(公有组机制)   |
| HOME=/home           | 新用户默认家目录位置                      |
| INACTIVE=-1          | 密码过期后宽限天数;-1 代表密码永不失效    |
| EXPIRE=              | 密码失效时间(时间戳),为空表示密码永不失效 |
| SHELL=/bin/bash      | 创建用户时默认shell类型                   |
| SKEL=/etc/skel       | 模板目录                                  |
| CREAT_MAIL_SPOOL=yes | 是否创建邮箱                              |

#### /etc/login.defs

| 字段                     | 描述                           |
| ------------------------ | ------------------------------ |
| MAIL_DIR /var/spool/mail | 新用户默认邮箱位置             |
| PASS_MAX_DAYS 99999      | 密码有效期                     |
| PASS_MIN_DAYS 0          | 密码修改间隔时间               |
| PASS_MIN_LEN 5           | 密码最小长度(PAM取代,字段失效) |
| PASS_WARN_AGE 7          | 密码修改到期前警告天数         |
| UID_MIN 1000             | 普通用户起始 UID               |
| UID_MAX 60000            | 普通用户最大 UID               |
| GID_MIN 1000             | 组起始 GID                     |
| GID_MAX 60000            | 组最大 GID                     |
| CREAT_HOME yes           | 是否创建家目录                 |
| UMASK 077                | 权限掩码                       |
| ENCRYPT_METHOD SHA512    | 用户密码加密模式               |

### 设置和修改密码

```shell
passwd [选项] 用户名 # 第一次使用是为指定用户创建密码,以后是修改密码
	-l # 锁定用户的密码,使之无法登录
	-u # 解锁用户密码
	-S # 查看用户账号状态(是否被锁定)
echo "123123" | passwd --stdin username # 非交互式修改密码
```

root 执行 passwd:

1.  可以给任何用户修改密码
2.  修改时无需提供原密码

普通用户执行 passwd:

1.  默认只能给自己修改密码(命令后不需写用户名)
2.  需要提供原密码
3.  要遵循密码各项原则(复杂度/长度)

### 用户信息修改(必须是存在用户)

```shell
usermod [选型] 用户名
	-u UID # 修改用户 UID
	-g 组名 # 修改初始组
	-d 目录 # 和 -m 同时使用,对原家目录改名
# 例子
usermod -m -d /home/user4home user4 # 将user4的家目录从 /home/user4 改为 /home/user4home
	-s shell类型 # 修改用户登录 shell 类型
	-L # 锁定用户密码
	-U # 解锁用户密码
	-l 新用户名 旧用户名 # 修改用户名
```

### 删除用户

```shell
userdel [选项] 用户名
	-r # 删除时,同时删除家目录
```

### 添加和删除组

```shell
groupadd 组名 # 添加组
groupdel 组名 # 删除组(尽量是空组)
```

### 向组内添加成员

```shell
gpasswd [选项] 用户名 组名
	-a # 向指定组添加成员
	-d # 从组内删除成员
	-M # 定义组内成员列表,用逗号分隔(覆盖式)
```

## 其他相关命令

```shell
id 用户名 # 显示用户的UID/初始组/附加组列表
su 用户名 # 切换用户身份
su - 用户名 # 切换身份同时切换环境
newgrp 组名 # 修改用户的有效组(暂时性,使用 exit 命令退回)
```

#### 有效组

有效组,决定了用户创建文件时,文件的属组

默认有效组是用户的初始组,当用户创建文件时,文件的属组是有效组